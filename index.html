<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OnlyRealRoles — Stop chasing ghosts. Start landing roles.</title>
  <meta name="description" content="OnlyRealRoles helps job seekers avoid ghost job postings by flagging suspicious listings and verifying employers." />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --ink: #0f172a; /* slate-900 */
      --muted: #475569; /* slate-600 */
      --ring: #cbd5e1; /* slate-300 */
      --brand: #1f4fd6; /* deep blue */
      --brand-ink: #ffffff;
      --accent: #f97316; /* orange */
      --success: #16a34a;
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: var(--bg);
      line-height: 1.5;
    }

    /* Layout */
    .wrap { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    header {
      position: sticky; top: 0; z-index: 50;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--ring);
    }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 68px; }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: -0.3px; }
    .brand .mark { width: 28px; height: 28px; display: grid; place-items: center; border-radius: 8px; background: var(--brand); color: var(--brand-ink); box-shadow: var(--shadow); font-size: 16px; font-weight: 900; }
    nav ul { display: none; gap: 22px; align-items: center; list-style: none; margin: 0; padding: 0; }
    nav a { text-decoration: none; color: var(--muted); font-weight: 600; }
    nav a:hover { color: var(--ink); }
    .actions { display: flex; gap: 10px; align-items:center; position:relative; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 14px; border-radius: 10px; border: 1px solid var(--ring); background: var(--card); color: var(--ink); font-weight: 700; text-decoration: none; box-shadow: var(--shadow); }
    .btn.primary { background: var(--brand); color: var(--brand-ink); border-color: transparent; }
    .btn.ghost { background: #fff; border-color: var(--ring); }

    /* Avatar dropdown (shown only when logged in) */
    .userarea{position:relative}
    .avatarBtn{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--ring);border-radius:999px;background:#fff;cursor:pointer;box-shadow:var(--shadow)}
    .miniava{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;background:#e2e8f0;color:#0f172a;font-weight:800;overflow:hidden}
    .miniava img{width:28px;height:28px;object-fit:cover;border-radius:999px}
    .caret{font-size:12px;color:#64748b}
    .menu{position:absolute;right:0;top:44px;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);min-width:200px;padding:8px;display:none}
    .menu.open{display:block}
    .menu a,.menu button{display:flex;width:100%;text-align:left;gap:8px;align-items:center;padding:8px 10px;border:none;background:none;color:#0f172a;border-radius:8px;cursor:pointer;text-decoration:none}
    .menu a:hover,.menu button:hover{background:#f1f5f9}
    .signout{color:#991b1b}

    /* Points pill */
    .pts{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--ring);border-radius:999px;
      padding:4px 8px;font-size:12px;background:#ecfeff;color:#0369a1;
    }

    /* Hero */
    .hero { padding: 56px 0 32px; }
    .hero .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
    .title { font-size: clamp(28px, 4.5vw, 46px); line-height: 1.1; margin: 0; letter-spacing: -0.8px; }
    .subtitle { margin: 12px 0 22px; color: var(--muted); max-width: 62ch; }
    .cta { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { background: var(--card); border: 1px solid var(--ring); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); }

    /* Main grid */
    .main { display: grid; grid-template-columns: 1fr; gap: 20px; padding-bottom: 56px; }

    /* Left info blocks under hero */
    .how ul { padding-left: 0; margin: 0; list-style: none; display: grid; gap: 12px; }
    .step { display: grid; grid-template-columns: 32px 1fr; gap: 12px; align-items: center; }
    .badge { width: 32px; height: 32px; display: grid; place-items: center; border-radius: 999px; background: #eef2ff; color: #3730a3; font-weight: 800; }

    /* Feed */
    .columns { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .feed .composer { display: grid; grid-template-columns: 1fr auto; gap: 12px; }
    .input { width: 100%; padding: 12px 14px; border: 1px solid var(--ring); border-radius: 12px; }
    .post { display: grid; gap: 8px; }
    .post .meta { display: flex; gap: 10px; align-items: center; color: var(--muted); font-size: 14px; flex-wrap: wrap; }
    .ghost-flag { display: inline-flex; align-items: center; gap: 8px; background: #fff7ed; border: 1px solid #fed7aa; color: #9a3412; padding: 8px 10px; border-radius: 8px; font-weight: 700; white-space: normal; }

    /* Text clamping + overflow safety */
    .post .meta strong, .post p, .list li strong, .list li div { overflow-wrap:anywhere; word-break:break-word; }
    .post .meta strong { display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; max-width:100%; }
    .post p { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; max-height:3.2em; }

    /* Right Column widgets */
    .search-box input { width: 100%; padding: 12px 14px; border: 1px solid var(--ring); border-radius: 10px; }
    .bars { display: grid; grid-template-columns: repeat(2, 1fr); align-items: end; gap: 16px; height: 140px; margin-top: 12px; }
    .bar { background: #e2e8f0; border-radius: 8px; position: relative; }
    .bar span { position: absolute; left: 50%; transform: translateX(-50%); bottom: -22px; font-size: 12px; color: var(--muted); }
    .bar.verified { background: var(--success); }
    .bar.flagged { background: #ef4444; }

    /* Lists */
    .list { display: grid; gap: 12px; padding: 0; margin: 0; list-style: none; }
    .list li { display: flex; align-items: center; justify-content: space-between; gap: 14px; padding: 12px; border: 1px solid var(--ring); border-radius: 12px; background: var(--card); }
    .pill { background: #fee2e2; color: #991b1b; font-weight: 700; padding: 6px 10px; border-radius: 999px; font-size: 12px; }

    /* Footer */
    footer { border-top: 1px solid var(--ring); background: #fff; }
    .foot { display: grid; grid-template-columns: 1fr; gap: 10px; padding: 24px 0; color: var(--muted); }
    .foot a { color: var(--muted); text-decoration: none; }
    .foot a:hover { color: var(--ink); }

    /* Responsive */
    @media (min-width: 900px) {
      nav ul { display: flex; }
      .hero .grid { grid-template-columns: 1.2fr 0.8fr; align-items: start; }
      .main { grid-template-columns: 1fr; }
      .columns { grid-template-columns: 2fr 1fr; }
      .foot { grid-template-columns: repeat(6, max-content); justify-content: space-between; align-items: center; }
    }

    /* skeleton */
    .skeleton{position:relative;overflow:hidden;background:#e2e8f0}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand">
        <div class="mark" aria-hidden="true">OR</div>
        <span>OnlyRealRoles</span>
      </div>
      <nav>
        <ul>
          <li><a href="/home/index.html" aria-current="page">Home</a></li>
          <li><a href="/report/index.html">Report a Ghost Job</a></li>
          <li><a href="/reports/index.html">View Public Reports</a></li>
          <li><a href="/how-it-works/index.html">How It Works</a></li>
          <li><a href="/network/index.html">Network</a></li>
        </ul>
      </nav>
      <div class="actions" id="authArea">
        <!-- Filled by auth script: Sign in/Sign up OR avatar menu + points -->
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Hero -->
    <section class="hero">
      <div class="grid">
        <div>
          <h1 class="title">Stop chasing ghosts. <br/>Start landing roles.</h1>
          <p class="subtitle">OnlyRealRoles helps you identify genuine job opportunities by flagging ghost postings and verifying employers — with community reports, transparency signals, and a clear Ghost Score.</p>
          <div class="cta">
            <a class="btn primary" href="/report/index.html">Report a Ghost Job</a>
            <a class="btn" href="#search">Find Real Roles</a>
          </div>
        </div>
        <aside class="card" id="search">
          <h3 style="margin: 0 0 8px;">Search Verified Employers</h3>
          <div class="search-box">
            <input type="search" placeholder="Search companies" aria-label="Search companies" />
          </div>
          <div class="bars">
            <div class="bar verified" style="height: 55%;"><span>Verified</span></div>
            <div class="bar flagged" style="height: 85%;"><span>Flagged</span></div>
          </div>
          <p style="font-size:12px;color:var(--muted);margin: 20px 0 4px;">* Demo data for illustration</p>
        </aside>
      </div>
    </section>

    <!-- How it Works + Feed layout -->
    <section class="main">
      <div class="columns">
        <!-- FEED (center) -->
        <section class="feed" aria-labelledby="dailyTopTitle">
          <div class="card composer">
            <input class="input" placeholder="Share a suspected ghost posting (paste URL)…" />
            <a class="btn primary" href="/report/index.html">Submit</a>
          </div>

          <h3 id="dailyTopTitle" style="margin:6px 0 8px">Top reports in the last 24 hours</h3>
          <div id="dailyFeed">
            <!-- skeleton while loading -->
            <article class="card post">
              <div class="skeleton" style="height:64px;border-radius:12px"></div>
            </article>
            <article class="card post">
              <div class="skeleton" style="height:64px;border-radius:12px"></div>
            </article>
            <article class="card post">
              <div class="skeleton" style="height:64px;border-radius:12px"></div>
            </article>
          </div>
        </section>

        <!-- RIGHT column widgets -->
        <aside class="stack" style="display:grid; gap: 20px;">
          <section class="card" id="how">
            <h3 style="margin:0 0 10px;">How It Works</h3>
            <ul class="how list" style="gap:14px;">
              <li class="step"><div class="badge">1</div><div>Report suspected ghost jobs by pasting a URL or uploading evidence.</div></li>
              <li class="step"><div class="badge">2</div><div>Community verifies signals. We compute a transparent Ghost Score.</div></li>
              <li class="step"><div class="badge">3</div><div>Browse verified employers and avoid high‑risk postings.</div></li>
            </ul>
          </section>

          <section class="card" aria-labelledby="watchlist-title">
            <h3 id="watchlist-title" style="margin:0 0 4px;">Ghost Employer Watchlist</h3>
            <div style="margin:0 0 10px;color:var(--muted);font-size:13px;">Highest Reported Ghost Listers by Company</div>
            <ul class="list" id="watchList">
              <li><div class="skeleton" style="height:22px;border-radius:8px;flex:1"></div></li>
              <li><div class="skeleton" style="height:22px;border-radius:8px;flex:1"></div></li>
              <li><div class="skeleton" style="height:22px;border-radius:8px;flex:1"></div></li>
              <li><div class="skeleton" style="height:22px;border-radius:8px;flex:1"></div></li>
            </ul>
          </section>

          <section class="card" id="chatter">
            <h3 style="margin:0 0 10px;">Community Chatter</h3>
            <ul class="list" id="chatterList">
              <li><div class="skeleton" style="height:22px;border-radius:8px;flex:1"></div></li>
              <li><div class="skeleton" style="height:22px;border-radius:8px;flex:1"></div></li>
              <li><div class="skeleton" style="height:22px;border-radius:8px;flex:1"></div></li>
            </ul>
            <div style="margin-top:8px">
              <a class="btn" href="/network/index.html">Open community</a>
            </div>
          </section>

          <section class="card" id="signup">
            <h3 style="margin:0 8px 10px 0;">Stay updated</h3>
            <form onsubmit="event.preventDefault(); alert('Thanks for signing up!');">
              <label class="visually-hidden" for="email">Email address</label>
              <input id="email" class="input" type="email" placeholder="Email address" required />
              <div class="cta" style="margin-top:10px;">
                <button class="btn primary" type="submit">Sign Up</button>
              </div>
            </form>
          </section>
        </aside>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap foot">
      <a href="#about">About</a>
      <a href="#contact">Contact</a>
      <a href="#terms">Terms</a>
      <a href="#privacy">Privacy</a>
      <a href="#verify">Employer Verification</a>
      <span>© <span id="year"></span> OnlyRealRoles</span>
    </div>
  </footer>

  <script>
    // Set current year in footer
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <!-- Inline auth-aware header WITH live points pill (robust) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, collection, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyC5Ug8_QjByQns-MMNnxVnb1XVyWcNRWgU',
      authDomain: 'onlyrealroles-896bc.firebaseapp.com',
      projectId: 'onlyrealroles-896bc',
      storageBucket: 'onlyrealroles-896bc.firebasestorage.app',
      messagingSenderId: '794319315637',
      appId: '1:794319315637:web:2c4862b9a9f6a8e7d554fc'
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const area = document.getElementById('authArea');
    if(area){
      // Render a safe default immediately so header never appears blank
      const ret = encodeURIComponent(location.pathname + location.search);
      area.innerHTML = `
        <a class="btn ghost" href="/sign_in/index.html?return=${ret}">Sign in</a>
        <a class="btn primary" href="/sign_in/index.html?tab=signup&return=${ret}">Sign up</a>
      `;
    }

    function attachPointsPill(user){
      try{
        const pill = document.getElementById('pointsPill');
        if(!pill) return;
        const q = query(collection(db,'ghost_reports'), where('uid','==', user.uid));
        return onSnapshot(q, (snap)=>{
          let total = 0;
          snap.forEach(d => { total += (d.data()?.votesUp || 0); });
          pill.textContent = `${total} pts`;
        }, (err)=>{
          console.warn('points pill listener error', err);
          pill.textContent = '0 pts';
        });
      }catch(e){ console.error('points pill setup failed', e); }
    }

    let detachPoints = null;
    function renderUserMenu(user){
      if(!area) return;
      if(!user){
        const ret = encodeURIComponent(location.pathname + location.search);
        area.innerHTML = `
          <a class="btn ghost" href="/sign_in/index.html?return=${ret}">Sign in</a>
          <a class="btn primary" href="/sign_in/index.html?tab=signup&return=${ret}">Sign up</a>
        `;
        if(detachPoints){ detachPoints(); detachPoints = null; }
        return;
      }
      const name = user.displayName || (user.email ? user.email.split('@')[0] : 'You');
      const initials = name.split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
      area.innerHTML = `
        <div class="userarea">
          <button class="avatarBtn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false">
            ${user.photoURL ? `<img src="${user.photoURL}" alt="" class="miniava" style="object-fit:cover"/>` : `<div class="miniava" aria-hidden="true">${initials}</div>`}
            <span>${name}</span>
            <span class="pts" id="pointsPill">— pts</span>
            <span class="caret">▾</span>
          </button>
          <div class="menu" id="userMenu" role="menu">
            <a href="/profile/index.html" role="menuitem">Profile</a>
            <a href="/profile/edit/index.html" role="menuitem">Edit profile</a>
            <a href="/network/index.html" role="menuitem">Network</a>
            <a href="/report/index.html" role="menuitem">Report a ghost job</a>
            <button class="signout" id="logoutBtn" role="menuitem">Sign out</button>
          </div>
        </div>`;

      const btn = document.getElementById('avatarBtn');
      const menu = document.getElementById('userMenu');
      btn?.addEventListener('click', ()=>{
        const open = menu.classList.toggle('open');
        btn.setAttribute('aria-expanded', String(open));
      });
      document.addEventListener('click', (e)=>{
        if(menu && !menu.contains(e.target) && !btn.contains(e.target)) menu.classList.remove('open');
      });
      document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{
        try{ await signOut(auth); location.replace('/sign_in/index.html'); } catch(e){ console.error(e); }
      });

      if(detachPoints){ detachPoints(); }
      detachPoints = attachPointsPill(user) || null;
    }

    onAuthStateChanged(auth, (u)=>{
      try{ renderUserMenu(u || null); }catch(e){ console.error('renderUserMenu failed', e); }
    });
  </script>

  <!-- Top 3 highest-rated reports in last 24h -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, query, where, orderBy, limit, onSnapshot, getDocs, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyC5Ug8_QjByQns-MMNnxVnb1XVyWcNRWgU',
      authDomain: 'onlyrealroles-896bc.firebaseapp.com',
      projectId: 'onlyrealroles-896bc',
      storageBucket: 'onlyrealroles-896bc.firebasestorage.app',
      messagingSenderId: '794319315637',
      appId: '1:794319315637:web:2c4862b9a9f6a8e7d554fc'
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const feed = document.getElementById('dailyFeed');

    const esc = (t)=> (t||'').toString().replace(/[&<>"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s]));
    const rel = (ms)=>{
      if(!ms) return ''; const diff = Date.now() - ms;
      const m = Math.floor(diff/60000); if(m<60) return `${m}m ago`;
      const h = Math.floor(m/60);       if(h<24) return `${h}h ago`;
      const d = Math.floor(h/24);       return `${d}d ago`;
    };

    function badge(up, down){
      const total = (up||0) + (down||0);
      const score = (up||0) - (down||0);
      if(total >= 3 && score >= 3) return { text:`Likely Ghost · Trust +${score}` };
      if(total >= 3 && score <= -3) return { text:`Likely Invalid · Trust ${score}` };
      return { text:`Under Review · Trust ${score>=0?'+':''}${score}` };
    }

    const cacheKey = 'orr_home_top_reports_v1';
    const loadCache = ()=>{ try{ return JSON.parse(localStorage.getItem(cacheKey)||'[]'); }catch{ return []; } };
    const saveCache = (items)=>{ try{ localStorage.setItem(cacheKey, JSON.stringify(items)); }catch{} };

    function itemCardHTML(item){
      const b = badge(item.votesUp||0, item.votesDown||0);
      const details = item.details ? esc(item.details).slice(0,160) + (item.details.length>160?'…':'') : '';
      return `
        <article class="card post">
          <div class="meta"><strong>${esc(item.company||'Unknown')} • ${esc(item.title||'Untitled')}</strong><span>·</span><span>Submitted ${rel(item.createdAtMillis)||''}</span></div>
          <div class="ghost-flag">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3c-4 0-7 3-7 7v8c0 .6.4 1 1 1s1-.4 1-1 .4-1 1-1 1 .4 1 1 .4 1 1 1 1-.4 1-1 .4-1 1-1 1 .4 1 1 .4 1 1 1 1-.4 1-1V10c0-4-3-7-7-7Z" fill="currentColor"/></svg>
            ${esc(b.text)} · <a href="/reports/post/index.html?id=${encodeURIComponent(item.id)}" style="margin-left:8px">View</a>
          </div>
          ${details ? `<p style="margin:6px 0 0;color:var(--muted)">${details}</p>` : ''}
        </article>`;
    }

    function snapToItem(s){
      const d = s.data();
      return {
        id: s.id,
        company: d.company || '',
        title: d.title || '',
        details: d.details || '',
        votesUp: d.votesUp || 0,
        votesDown: d.votesDown || 0,
        createdAtMillis: d.createdAt?.toMillis?.() || 0
      };
    }

    function render(items){
      if(!items || items.length===0) return; // keep whatever is already shown
      feed.dataset.rendered = '1';
      feed.innerHTML = items.map(itemCardHTML).join('');
    }

    // 1) Prime UI with cache so list never goes blank on reload
    const cached = loadCache();
    if(cached.length){ render(cached); }

    // 2) Live top-3 from the last 24h
    const since24 = new Date(Date.now() - 24*60*60*1000);
    const q24 = query(
      collection(db,'ghost_reports'),
      where('createdAt','>=', Timestamp.fromDate(since24)),
      orderBy('createdAt','desc'),
      limit(100)
    );

    let didFallback = false;

    onSnapshot(q24, async (snap)=>{
      if(!snap.empty){
        const top = snap.docs
          .map(snapToItem)
          .sort((a,b)=>{ const as=(a.votesUp-a.votesDown), bs=(b.votesUp-b.votesDown); if(bs!==as) return bs-as; return b.createdAtMillis-a.createdAtMillis; })
          .slice(0,3);
        render(top);
        saveCache(top);
        return;
      }

      // If there are no fresh items, keep showing what's on screen.
      if(feed.dataset.rendered==='1'){ return; }

      // 3) Fallback once: look back 7 days, then all recent
      if(didFallback) return; didFallback = true;
      try{
        const since7 = new Date(Date.now() - 7*24*60*60*1000);
        const q7 = query(collection(db,'ghost_reports'), where('createdAt','>=', Timestamp.fromDate(since7)), orderBy('createdAt','desc'), limit(200));
        let docs = (await getDocs(q7)).docs;
        if(docs.length===0){
          // last resort: latest 200 regardless of date
          const qAny = query(collection(db,'ghost_reports'), orderBy('createdAt','desc'), limit(200));
          docs = (await getDocs(qAny)).docs;
        }
        const topOld = docs.map(snapToItem)
          .sort((a,b)=>{ const as=(a.votesUp-a.votesDown), bs=(b.votesUp-b.votesDown); if(bs!==as) return bs-as; return b.createdAtMillis-a.createdAtMillis; })
          .slice(0,3);
        if(topOld.length){ render(topOld); saveCache(topOld); }
      }catch(e){ /* swallow – keep cache/skeleton */ }
    }, (err)=>{
      // On error, keep cache (do not wipe). If nothing shown yet, show graceful message.
      if(feed.dataset.rendered!=='1'){
        const cached = loadCache();
        if(cached.length){ render(cached); }
        else { feed.innerHTML = `<article class="card post" style="color:#b91c1c">Error: ${esc(err.message||err)}</article>`; }
      }
    });
  </script>

  <!-- Community Chatter: Top rated posts from last 24h -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, query, where, orderBy, limit, onSnapshot, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyC5Ug8_QjByQns-MMNnxVnb1XVyWcNRWgU',
      authDomain: 'onlyrealroles-896bc.firebaseapp.com',
      projectId: 'onlyrealroles-896bc',
      storageBucket: 'onlyrealroles-896bc.firebasestorage.app',
      messagingSenderId: '794319315637',
      appId: '1:794319315637:web:2c4862b9a9f6a8e7d554fc'
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const list = document.getElementById('chatterList');
    const esc = (t)=> (t||'').toString().replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s]));
    const rel = (ts)=>{ if(!ts?.toMillis) return ''; const ms=Date.now()-ts.toMillis(); const m=Math.floor(ms/60000); if(m<60) return `${m}m`; const h=Math.floor(m/60); if(h<24) return `${h}h`; const d=Math.floor(h/24); return `${d}d`; };

    function itemHTML(id, d){
      const score = (d.votesUp||0) - (d.votesDown||0);
      const pillStyle = score>=0 ? 'background:#eef2ff;color:#1f4fd6;border:1px solid #c7d2fe' : 'background:#fee2e2;color:#991b1b;border:1px solid #fecaca';
      const topic = d.topic ? ` • ${esc(d.topic)}` : '';
      return `<li>
        <a href="/network/index.html?post=${encodeURIComponent(id)}" style="text-decoration:none;color:inherit">
          <div><strong>${esc(d.title||'Untitled')}</strong><div style="color:var(--muted);font-size:13px;">${esc(d.tags?.[0]||d.type||'post')}${topic} • ${rel(d.createdAt)||''}</div></div>
        </a>
        <span class="pill" style="${pillStyle}" title="Trust score">${score>=0?'+':''}${score}</span>
      </li>`;
    }

    const since = new Date(Date.now() - 24*60*60*1000);
    const q = query(
      collection(db,'network_posts'),
      where('status','==','published'),
      where('visibility','==','public'),
      where('createdAt','>=', Timestamp.fromDate(since)),
      orderBy('createdAt','desc'),
      limit(50)
    );

    onSnapshot(q,(snap)=>{
      if(snap.empty){
        list.innerHTML = `<li style="color:var(--muted)">No top posts in the last 24 hours yet. <a href="/network/index.html">Visit the community</a>.</li>`;
        return;
      }
      const top = snap.docs
        .map(s=>({ id:s.id, d:s.data() }))
        .filter(x=>x.d.status==='published' && x.d.visibility==='public')
        .map(x=>({ ...x, score:(x.d.votesUp||0)-(x.d.votesDown||0) }))
        .sort((a,b)=>{ if(b.score!==a.score) return b.score-a.score; const at=a.d.createdAt?.toMillis?.()||0; const bt=b.d.createdAt?.toMillis?.()||0; return bt-at; })
        .slice(0,5);
      list.innerHTML = top.map(x=>itemHTML(x.id,x.d)).join('');
    }, (err)=>{
      list.innerHTML = `<li style="color:#b91c1c">Error loading community posts. Please try again shortly.</li>`;
      console.error('Community Chatter error', err);
    });
  </script>

  <!-- Robust Community Chatter loader (index-free + fallback + cache). Runs after earlier script and overrides output. -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const el = document.getElementById('chatterList');
    if(el && !el.dataset.init){
      el.dataset.init = '1';
      const firebaseConfig = {
        apiKey: 'AIzaSyC5Ug8_QjByQns-MMNnxVnb1XVyWcNRWgU',
        authDomain: 'onlyrealroles-896bc.firebaseapp.com',
        projectId: 'onlyrealroles-896bc',
        storageBucket: 'onlyrealroles-896bc.firebasestorage.app',
        messagingSenderId: '794319315637',
        appId: '1:794319315637:web:2c4862b9a9f6a8e7d554fc'
      };
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      const esc = (t)=> (t||'').toString().replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s]));
      const rel = (ms)=>{ const d=Date.now()-ms; const m=Math.floor(d/60000); if(m<60) return `${m}m`; const h=Math.floor(m/60); if(h<24) return `${h}h`; const dd=Math.floor(h/24); return `${dd}d`; };
      const since = Date.now() - 24*60*60*1000;

      const cacheKey='orr_home_chatter_v1';
      const loadCache=()=>{ try{return JSON.parse(localStorage.getItem(cacheKey)||'[]');}catch{return [];} };
      const saveCache=(items)=>{ try{localStorage.setItem(cacheKey, JSON.stringify(items));}catch{} };

      function itemHTML(id, d){
        const score=(d.votesUp||0)-(d.votesDown||0);
        const pillStyle = score>=0 ? 'background:#eef2ff;color:#1f4fd6;border:1px solid #c7d2fe' : 'background:#fee2e2;color:#991b1b;border:1px solid #fecaca';
        const topic = d.topic ? ` • ${esc(d.topic)}` : '';
        return `<li>
          <a href="/network/index.html?post=${encodeURIComponent(id)}" style="text-decoration:none;color:inherit">
            <div><strong>${esc(d.title||'Untitled')}</strong><div style="color:var(--muted);font-size:13px;">${esc(d.tags?.[0]||d.type||'post')}${topic} • ${rel(d.createdAt?.toMillis?.()||0)}</div></div>
          </a>
          <span class="pill" style="${pillStyle}" title="Trust score">${score>=0?'+':''}${score}</span>
        </li>`;
      }

      function renderList(docs){
        const top = docs
          .map(s=>({ id:s.id, d:s.data() }))
          .filter(x=>x.d && x.d.status==='published' && x.d.visibility==='public')
          .filter(x=> (x.d.createdAt?.toMillis?.()||0) >= since)
          .map(x=>({ ...x, score:(x.d.votesUp||0)-(x.d.votesDown||0) }))
          .sort((a,b)=>{ if(b.score!==a.score) return b.score-a.score; const at=a.d.createdAt?.toMillis?.()||0; const bt=b.d.createdAt?.toMillis?.()||0; return bt-at; })
          .slice(0,5);
        if(top.length===0){
          el.innerHTML = `<li style=\"color:var(--muted)\">No top posts in the last 24 hours yet. <a href=\"/network/index.html\">Visit the community</a>.</li>`;
          return [];
        }
        el.innerHTML = top.map(x=>itemHTML(x.id,x.d)).join('');
        return top.map(x=>({id:x.id, d:x.d}));
      }

      // Prime from cache first
      const cached = loadCache();
      if(cached.length){ try{ el.innerHTML = cached.map(x=>itemHTML(x.id,x.d)).join(''); }catch{} }

      // Realtime (index-light): order by createdAt only and filter in JS
      const q = query(collection(db,'network_posts'), orderBy('createdAt','desc'), limit(100));
      onSnapshot(q, (snap)=>{
        const toCache = renderList(snap.docs);
        if(toCache.length) saveCache(toCache);
      }, async (err)=>{
        console.error('Chatter snapshot error', err);
        // Fallback: no-order fetch
        try{
          const snap = await getDocs(query(collection(db,'network_posts'), limit(200)));
          const toCache = renderList(snap.docs);
          if(toCache.length) saveCache(toCache);
        }catch(e){
          console.error('Chatter fallback getDocs error', e);
          if(!cached.length){
            el.innerHTML = `<li style=\"color:#b91c1c\">Error loading community posts. Please try again shortly.</li>`;
          }
        }
      });
    }
  </script>

  <!-- Ghost Employer Watchlist: aggregate top companies by # of reports (live, cache-backed) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyC5Ug8_QjByQns-MMNnxVnb1XVyWcNRWgU',
      authDomain: 'onlyrealroles-896bc.firebaseapp.com',
      projectId: 'onlyrealroles-896bc',
      storageBucket: 'onlyrealroles-896bc.firebasestorage.app',
      messagingSenderId: '794319315637',
      appId: '1:794319315637:web:2c4862b9a9f6a8e7d554fc'
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const listEl = document.getElementById('watchList');
    if(listEl){
      const esc = (t)=> (t||'').toString().replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s]));
      const cacheKey='orr_home_watch_companies_v1';
      const loadCache=()=>{ try{return JSON.parse(localStorage.getItem(cacheKey)||'[]');}catch{return [];} };
      const saveCache=(arr)=>{ try{localStorage.setItem(cacheKey, JSON.stringify(arr));}catch{} };

      function render(items){
        if(!items || items.length===0){
          listEl.innerHTML = `<li style="color:var(--muted)">No companies reported yet.</li>`;
          return;
        }
        listEl.innerHTML = items.map(it => `
          <li>
            <div>
              <strong>${esc(it.displayName)}</strong>
              <div style="color:var(--muted);font-size:13px;">${it.count} report${it.count===1?'':'s'}</div>
            </div>
            <span class="pill" style="background:#eef2ff;color:#1f4fd6;border:1px solid #c7d2fe" title="# of reports">${it.count}</span>
          </li>`).join('');
      }

      const cached = loadCache(); if(cached.length){ render(cached); }

      // Pull most recent 300 reports and aggregate by company (case-insensitive)
      const qy = query(collection(db,'ghost_reports'), orderBy('createdAt','desc'), limit(300));
      onSnapshot(qy, (snap)=>{
        const map = new Map();
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const raw = (d.company||'').toString().trim();
          if(!raw) return;
          const key = raw.toLowerCase();
          const prev = map.get(key) || { displayName: raw, count: 0, lastMillis: 0 };
          const created = d.createdAt?.toMillis?.() || 0;
          // prefer newest casing / spelling for display
          const display = prev.lastMillis > created ? prev.displayName : raw;
          map.set(key, { displayName: display, count: prev.count + 1, lastMillis: Math.max(prev.lastMillis, created) });
        });
        const top = Array.from(map.values())
          .sort((a,b)=> b.count - a.count || b.lastMillis - a.lastMillis || a.displayName.localeCompare(b.displayName))
          .slice(0,4);
        render(top);
        saveCache(top);
      }, (err)=>{
        console.error('Watchlist load error', err);
        const cached = loadCache();
        if(cached.length){ render(cached); }
        else { listEl.innerHTML = `<li style=\"color:#b91c1c\">Error loading watchlist. Please try again later.</li>`; }
      });
    }
  </script>
</body>
</html>
