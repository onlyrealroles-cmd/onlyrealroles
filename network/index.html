<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Real Role Network — Hires helping hires</title>
<meta name="description" content="Share job search stories, verified openings, and hiring signals. Hires helping hires on the Real Role Network." />
<style>
  :root{--bg:#f5f7fb;--card:#fff;--ink:#0f172a;--muted:#475569;--ring:#cbd5e1;--brand:#1f4fd6;--shadow:0 10px 30px rgba(2,6,23,.08);--radius:14px;--sticky-top:92px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);line-height:1.6}
  .wrap{max-width:1280px;margin:0 auto;padding:0 18px}
  header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);border-bottom:1px solid var(--ring)}
  .nav{display:flex;align-items:center;justify-content:space-between;height:68px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:-.3px}
  .mark{width:28px;height:28px;display:grid;place-items:center;border-radius:8px;background:var(--brand);color:#fff;box-shadow:var(--shadow);font-size:16px;font-weight:900}
  nav ul{display:flex;gap:22px;list-style:none;margin:0;padding:0}
  nav a{text-decoration:none;color:var(--muted);font-weight:600}
  nav a:hover{color:var(--ink)}
  .actions{display:flex;gap:10px;align-items:center;position:relative}

  /* Header user menu + points pill */
  .userarea{position:relative}
  .avatarBtn{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--ring);border-radius:999px;background:#fff;cursor:pointer;box-shadow:var(--shadow)}
  .miniava{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;background:#e2e8f0;color:#0f172a;font-weight:800;overflow:hidden}
  .points{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1f4fd6;border:1px solid #c7d2fe;font-weight:800;font-size:12px}
  .caret{font-size:12px;color:#64748b}
  .menu{position:absolute;right:0;top:44px;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);min-width:220px;padding:8px;display:none}
  .menu.open{display:block}
  .menu a,.menu button{display:flex;width:100%;text-align:left;gap:8px;align-items:center;padding:8px 10px;border:none;background:none;color:#0f172a;border-radius:8px;cursor:pointer;text-decoration:none}
  .menu a:hover,.menu button:hover{background:#f1f5f9}
  .signout{color:#991b1b}

  .hero{padding:24px 0 14px}
  .title{margin:0 0 6px;font-size:clamp(28px,4vw,42px);letter-spacing:-.6px}
  .subtitle{color:var(--muted);margin:0 0 12px}

  /* 3-column layout */
  .grid3{display:grid;grid-template-columns:250px minmax(0,1fr) 340px;gap:20px;padding-bottom:16px}
  @media(max-width:1180px){.grid3{grid-template-columns:220px minmax(0,1fr)}}
  @media(max-width:920px){.grid3{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}

  /* Left rail */
  .leftcol{display:grid;gap:16px;position:sticky;top:var(--sticky-top);align-self:start;height:calc(100vh - var(--sticky-top) - 16px)}
  .leftcol .box{padding:16px}
  .railTitle{margin:0 0 10px}
  .railList{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .railList a{color:#0f172a;text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid var(--ring);background:#fff;display:block;font-weight:700}
  .railList a:hover{background:#f8fafc}
  .pillSmall{display:inline-block;background:#e2e8f0;border:1px solid var(--ring);border-radius:999px;padding:2px 8px;font-size:12px;color:#334155}
  .muted{color:#64748b}

  /* Center */
  .centercol{display:grid;gap:16px;overflow:visible}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;padding:10px 16px}
  .select{padding:8px 10px;border:1px solid var(--ring);border-radius:10px;background:#fff}
  .feedwrap{overflow-y:auto;overflow-x:hidden;padding-right:6px}
  .feed{display:grid;gap:16px}

  .post{display:grid;gap:10px;padding:14px;border:1px solid var(--ring);border-radius:12px;background:#fff;overflow-wrap:anywhere;word-break:break-word}
  .head{display:flex;gap:10px;align-items:center}
  .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:14px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--ring);font-size:12px;background:#fff}
  .chip.topic{background:#f1f5f9;color:#0f172a}
  .chip.topic.exp{background:#fff7ed;color:#9a3412}
  .chip.topic.signal{background:#eff6ff;color:#1d4ed8}
  .chip.topic.t3{background:#ecfeff;color:#155e75}
  .chip.topic.t4{background:#f5f3ff;color:#6d28d9}
  .chip.topic.t5{background:#ecfdf5;color:#065f46}
  .chip.topic.t6{background:#fefce8;color:#854d0e}
  .chip.job{background:#e2e8f0;color:#0f172a}
  .chip.type{background:#f1f5f9;color:#334155}

  .post-title{margin:0}
  .post-title a{color:#0f172a;text-decoration:none}
  .post-title a:hover{text-decoration:underline}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#334155;font-size:12px}

  .media-single img{max-width:100%;width:100%;height:auto;border-radius:10px;border:1px solid var(--ring);display:block}
  .media-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .media-grid img{max-width:100%;width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:10px;border:1px solid var(--ring)}

  .actionsBar{display:flex;gap:14px;align-items:center;color:var(--muted);font-weight:600}
  .voteGroup{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:4px 8px;background:#fff}
  .voteBtn{border:none;background:#fff;border-radius:999px;padding:6px 8px;cursor:pointer;font-weight:900;color:#334155}
  .voteBtn:hover{background:#f1f5f9}
  .voteBtn.active{background:#e0ecff;color:#1f4fd6}
  .voteCount{min-width:26px;text-align:center;font-weight:800;color:#0f172a}
</style>
</head>
<body>
<header>
  <div class="wrap nav">
    <div class="brand"><div class="mark" aria-hidden="true">OR</div><span>OnlyRealRoles</span></div>
    <nav>
      <ul>
        <li><a href="/home/index.html">Home</a></li>
        <li><a href="/report/index.html">Report a Ghost Job</a></li>
        <li><a href="/reports/index.html">View Public Reports</a></li>
        <li><a href="/how-it-works/index.html">How It Works</a></li>
        <li><a href="#" aria-current="page">Network</a></li>
      </ul>
    </nav>
    <div class="actions" id="authArea"></div>
  </div>
</header>

<section class="wrap hero">
  <h1 class="title">Real Role Network</h1>
  <p class="subtitle">Hires helping hires. Share your journey, signal real openings, and learn from others—without the ghosts.</p>
</section>

<main class="wrap grid3" id="grid">
  <!-- LEFT RAIL: now 3 boxes -->
  <aside class="leftcol">
    <section class="card box">
      <h3 class="railTitle">Navigate</h3>
      <ul class="railList">
        <li><a href="/network/create/index.html">Create a post</a></li>
        <li><a href="/home/index.html">Home</a></li>
        <li><a href="/reports/index.html">Public reports</a></li>
      </ul>
    </section>

    <section class="card box" id="topicsBox">
      <h3 class="railTitle">Followed topics</h3>
      <div id="topicsList" style="display:flex;flex-wrap:wrap;gap:8px"></div>
      <div id="topicsEmpty" class="muted">Sign in to see your topics.</div>
    </section>

    <section class="card box" id="followsBox">
      <h3 class="railTitle">Followed users</h3>
      <ul class="railList" id="followUsers"></ul>
      <div id="followsEmpty" class="muted">Sign in to follow people.</div>
    </section>
  </aside>

  <!-- CENTER FEED -->
  <section class="centercol" id="centercol">
    <div class="card toolbar">
      <a class="btn" style="background:#1f4fd6;color:#fff;border-color:transparent" href="/network/create/index.html">Create Post</a>
      <div style="display:flex;gap:8px;align-items:center">
        <label for="sort" class="meta">Sort</label>
        <select class="select" id="sort">
          <option value="new">Newest</option>
          <option value="top24">Top (last 24h)</option>
        </select>
      </div>
    </div>

    <div class="feedwrap" id="feedwrap">
      <div class="feed" id="feed"></div>
    </div>
  </section>

  <!-- RIGHT RAIL (unchanged) -->
  <aside class="rightcol">
    <div class="card box">
      <h3 style="margin:0 0 8px">Rules & tips</h3>
      <ul style="margin:0;padding-left:16px;color:#475569">
        <li>No PII (emails/phone).</li>
        <li>Share facts; avoid naming individuals.</li>
        <li>Evidence encouraged (blur sensitive bits).</li>
      </ul>
    </div>
  </aside>
</main>

<footer>
  <div class="wrap" style="border-top:1px solid var(--ring);padding:24px 0;color:var(--muted);display:flex;flex-wrap:wrap;gap:14px;justify-content:space-between">
    <div style="display:flex;gap:14px;flex-wrap:wrap">
      <a href="/about" style="color:var(--muted);text-decoration:none">About</a>
      <a href="/contact" style="color:var(--muted);text-decoration:none">Contact</a>
      <a href="/terms" style="color:var(--muted);text-decoration:none">Terms</a>
      <a href="/privacy" style="color:var(--muted);text-decoration:none">Privacy</a>
    </div>
    <span>© <span id="year"></span> OnlyRealRoles</span>
  </div>
</footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();
  function setCenterHeight(){
    const center = document.getElementById('centercol');
    const feedwrap = document.getElementById('feedwrap');
    const rect = center.getBoundingClientRect();
    const avail = window.innerHeight - rect.top - 24;
    feedwrap.style.maxHeight = avail + 'px';
  }
  window.addEventListener('load', setCenterHeight);
  window.addEventListener('resize', setCenterHeight);
</script>

<!-- Firebase + feed + header + left-rail wiring -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import {
    getFirestore, collection, query, where, orderBy, limit, onSnapshot,
    getDoc, doc, serverTimestamp, setDoc, deleteDoc,
    runTransaction, increment
  } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyC5Ug8_QjByQns-MMNnxVnb1XVyWcNRWgU",
    authDomain: "onlyrealroles-896bc.firebaseapp.com",
    projectId: "onlyrealroles-896bc",
    storageBucket: "onlyrealroles-896bc.firebasestorage.app",
    messagingSenderId: "794319315637",
    appId: "1:794319315637:web:2c4862b9a9f6a8e7d554fc"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const feedEl = $('#feed');
  const authorCache = new Map();

  // Prime header so it never appears blank
  (function primeHeader(){
    const area = $('#authArea');
    if(!area) return;
    const ret = encodeURIComponent(location.pathname + location.search);
    area.innerHTML = `
      <a class="btn" href="/sign_in/index.html?return=${ret}">Sign in</a>
      <a class="btn primary" href="/sign_in/index.html?tab=signup&return=${ret}">Sign up</a>
    `;
  })();

  // Points pill: sum votesUp across your ghost_reports
  function attachPointsPill(user){
    try{
      const pill = document.getElementById('pointsPill');
      if(!pill) return;
      const q = query(collection(db,'ghost_reports'), where('uid','==', user.uid));
      return onSnapshot(q, (snap)=>{
        let total = 0; snap.forEach(d=>{ total += (d.data()?.votesUp || 0); });
        pill.textContent = `${total} pts`;
      }, ()=>{ pill.textContent = '0 pts'; });
    }catch(e){ console.warn('points pill failed', e); }
  }
  let detachPoints = null;

  // Followed users rail
  let unsubFollowing = null;
  function wireFollowedUsers(user){
    const list  = $('#followUsers');
    const empty = $('#followsEmpty');
    if(!list || !empty) return;

    list.innerHTML = '';
    empty.style.display = 'block';
    empty.textContent = user ? 'Loading…' : 'Sign in to follow people.';

    if (typeof unsubFollowing === 'function') { try{unsubFollowing();}catch{} unsubFollowing = null; }
    if(!user) return;

    const fq = query(
      collection(db, 'users', user.uid, 'following'),
      orderBy('createdAt', 'desc'),
      limit(15)
    );

    unsubFollowing = onSnapshot(fq, (snap)=>{
      list.innerHTML = '';
      let any = false;
      snap.forEach(row=>{
        any = true;
        const data = row.data() || {};
        const targetUid = data.uid || row.id;
        const name = data.name || 'User';
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.href   = `/profile/view/index.html?id=${encodeURIComponent(targetUid)}`;
        a.textContent = name;
        li.appendChild(a);
        list.appendChild(li);
      });
      empty.style.display = any ? 'none' : 'block';
      if(!any) empty.textContent = 'You’re not following anyone yet.';
    }, ()=>{
      list.innerHTML = '';
      empty.style.display = 'block';
      empty.textContent = 'Unable to load followed users.';
    });
  }

  // Header (dropdown + points) and topic rail
  async function renderHeaderAndRails(user){
    const area = $('#authArea');
    if(!area) return;

    if(!user){
      const ret = encodeURIComponent(location.pathname + location.search);
      area.innerHTML = `
        <a class="btn" href="/sign_in/index.html?return=${ret}">Sign in</a>
        <a class="btn primary" href="/sign_in/index.html?tab=signup&return=${ret}">Sign up</a>
      `;
      if(detachPoints){ try{detachPoints();}catch{} detachPoints=null; }
      // rails in signed-out state
      $('#topicsList').innerHTML='';
      $('#topicsEmpty').textContent='Sign in to see your topics.';
      $('#topicsEmpty').style.display='block';
      wireFollowedUsers(null);
      return;
    }

    // profile basics for header + topics for rail
    let displayName = user.displayName || (user.email? user.email.split('@')[0] : 'You');
    let avatarUrl = user.photoURL || '';
    try{
      const prof = await getDoc(doc(db,'users', user.uid));
      if(prof.exists()){
        const d = prof.data();
        displayName = d.displayName || displayName;
        avatarUrl = d.avatarUrl || avatarUrl;

        const topics = Array.isArray(d.topics)? d.topics.slice(0,25) : [];
        const tBox = $('#topicsList'); tBox.innerHTML='';
        if(topics.length){
          topics.forEach(t => tBox.insertAdjacentHTML('beforeend', `<span class="pillSmall">${(t||'').toString()}</span>`));
          $('#topicsEmpty').style.display='none';
        }else{
          $('#topicsEmpty').textContent='No followed topics yet.';
          $('#topicsEmpty').style.display='block';
        }
      }else{
        $('#topicsList').innerHTML='';
        $('#topicsEmpty').textContent='No profile yet.';
        $('#topicsEmpty').style.display='block';
      }
    }catch{
      $('#topicsList').innerHTML='';
      $('#topicsEmpty').textContent='Unable to load topics.';
      $('#topicsEmpty').style.display='block';
    }

    const initials = (displayName||'U').split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
    area.innerHTML = `
      <div class="userarea">
        <button class="avatarBtn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false">
          ${avatarUrl ? `<img src="${avatarUrl}" alt="" class="miniava" style="width:28px;height:28px;border-radius:999px;object-fit:cover"/>` : `<div class="miniava" aria-hidden="true">${initials}</div>`}
          <span>${displayName}</span>
          <span class="points" id="pointsPill">— pts</span>
          <span class="caret">▾</span>
        </button>
        <div class="menu" id="userMenu" role="menu">
          <a href="/profile/index.html" role="menuitem">Profile</a>
          <a href="/profile/edit/index.html" role="menuitem">Settings</a>
          <button class="signout" id="logoutBtn" role="menuitem">Sign out</button>
        </div>
      </div>`;
    const btn=$('#avatarBtn'), menu=$('#userMenu');
    btn.addEventListener('click', ()=>{ const open=menu.classList.toggle('open'); btn.setAttribute('aria-expanded', String(open)); });
    document.addEventListener('click', (e)=>{ if(!menu.contains(e.target)&&!btn.contains(e.target)) menu.classList.remove('open'); });
    $('#logoutBtn').addEventListener('click', async ()=>{ try{ await signOut(auth); location.reload(); } catch(e){ console.error(e); }});

    if(detachPoints){ try{detachPoints();}catch{} }
    detachPoints = attachPointsPill(user) || null;
    wireFollowedUsers(user);
  }
  onAuthStateChanged(auth, u => renderHeaderAndRails(u||null));

  /* ---------- FEED (unchanged) ---------- */
  function relTime(ts){ if(!ts) return ''; const ms=Date.now()-(ts?.toMillis?.()||0); const m=Math.floor(ms/60000); if(m<60)return`${m}m`; const h=Math.floor(m/60); if(h<24)return`${h}h`; const d=Math.floor(h/24); return`${d}d`; }
  async function getAuthor(uid){
    if(authorCache.has(uid)) return authorCache.get(uid);
    try{
      const snap = await getDoc(doc(db,'users',uid));
      const d = snap.exists()? snap.data(): {};
      const out = { name:d.displayName||'User', headline:d.headline||'', location:d.location||'', avatarUrl:d.avatarUrl||'' };
      authorCache.set(uid,out); return out;
    }catch{return{name:'User',headline:'',location:'',avatarUrl:''}}
  }
  const typeLabel = t => (t==='media'?'Images & Video': t==='link'?'Link': t==='poll'?'Poll':'Text');
  function topicKey(t){
    if(!t) return 't3';
    const x = t.toLowerCase();
    if(x.startsWith('experience')) return 'exp';
    if(x.startsWith('hiring'))     return 'signal';
    if(x.endsWith(' 3') || x==='topic 3') return 't3';
    if(x.endsWith(' 4') || x==='topic 4') return 't4';
    if(x.endsWith(' 5') || x==='topic 5') return 't5';
    if(x.endsWith(' 6') || x==='topic 6') return 't6';
    return 't3';
  }

  function postMediaHTML(d){
    if(d.type === 'media' && d.content?.urls?.length){
      const urls=d.content.urls;
      return urls.length===1
        ? `<div class="media-single"><img src="${urls[0]}" alt="media"></div>`
        : `<div class="media-grid">${urls.slice(0,4).map(u=>`<img src="${u}" alt="media">`).join('')}</div>`;
    }
    return '';
  }
  function postBodyPreview(d){
    if(d.type==='text' && d.content?.body){ const t=d.content.body; return `<p>${t.length>400?t.slice(0,400)+'…':t}</p>`; }
    if(d.type==='link' && d.content?.url){ const note=d.content?.note?`<div class="meta" style="margin-top:4px">${d.content.note}</div>`:''; return `<p><a href="${d.content.url}" target="_blank" rel="noopener">${d.content.url}</a></p>${note}`; }
    if(d.type==='poll'){ const opts=(d.content?.options||[]).slice(0,3).map(o=>`<span class="tag">${o}</span>`).join(''); return `<div class="tags">${opts}</div>`; }
    return '';
  }
  const netVotes = d => (d.votesUp||0)-(d.votesDown||0);

  function postCardHTML(id,d,author){
    const tags=(d.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
    const when = relTime(d.createdAt);
    const topicClass = topicKey(d.topic);

    return `
      <article class="post" id="post-${id}">
        <div class="head">
          <div class="miniava" aria-hidden="true" style="width:28px;height:28px;border-radius:999px;background:#e2e8f0"></div>
          <div>
            <strong>${author.name}</strong> · <span class="meta">${when}${author.location?` · ${author.location}`:''}</span>
            <div class="meta">
              <span class="chip topic ${topicClass}">${d.topic || 'General'}</span>
              ${ d.topic==='Hiring Signal' && d.jobType ? `<span class="chip job">${d.jobType}</span>` : `` }
              <span class="chip type">${typeLabel(d.type)}</span>
            </div>
          </div>
        </div>

        <h3 class="post-title"><a href="/network/post/index.html?id=${id}">${d.title||'(no title)'}</a></h3>
        ${postBodyPreview(d)}
        ${postMediaHTML(d)}
        <div class="tags">${tags}</div>

        <div class="actionsBar">
          <div class="voteGroup" data-id="${id}">
            <button class="voteBtn" data-v="1"  title="Upvote">▲</button>
            <span class="voteCount" id="vcount-${id}">${netVotes(d)}</span>
            <button class="voteBtn" data-v="-1" title="Downvote">▼</button>
          </div>
          <a href="/network/post/index.html?id=${id}" style="text-decoration:none">Comment</a>
          <span>Share</span>
        </div>
      </article>`;
  }

  async function renderFeed(docs){
    feedEl.innerHTML='';
    if(!docs.length){ feedEl.innerHTML = `<div class="card" style="padding:14px;color:#64748b">No posts yet.</div>`; return; }
    for(const snap of docs){
      const d=snap.data(), id=snap.id; const author = await getAuthor(d.uid);
      feedEl.insertAdjacentHTML('beforeend', postCardHTML(id,d,author));
    }
    wireVotes();
    markMyVotes();
  }

  function setActive(group, v){
    group.querySelectorAll('.voteBtn').forEach(b=>b.classList.remove('active'));
    if(v === 1)  group.querySelector('.voteBtn[data-v="1"]').classList.add('active');
    if(v === -1) group.querySelector('.voteBtn[data-v="-1"]').classList.add('active');
  }

  async function markMyVotes(){
    const u = auth.currentUser; if(!u) return;
    for(const group of $$('.voteGroup')){
      const postId = group.getAttribute('data-id');
      try{
        const s = await getDoc(doc(db,'network_posts',postId,'votes',u.uid));
        setActive(group, s.exists() ? (s.data().value||0) : 0);
      }catch(e){ console.warn('vote state read failed', e); }
    }
  }

  async function handleVote(postId, newVal){
    const user = auth.currentUser;
    if(!user){ location.href = '/sign_in/index.html?return=' + encodeURIComponent(location.pathname + location.search); return; }

    const pRef = doc(db,'network_posts',postId);
    const vRef = doc(db,'network_posts',postId,'votes',user.uid);

    await runTransaction(db, async (tx)=>{
      const vSnap = await tx.get(vRef);
      const prevVal = vSnap.exists() ? (vSnap.data().value||0) : 0;

      let deltaUp = 0, deltaDown = 0, nextVal = 0;

      if(prevVal === newVal){
        nextVal = 0;
        if(prevVal === 1)  deltaUp   = -1;
        if(prevVal === -1) deltaDown = -1;
        tx.delete(vRef);
      } else {
        nextVal = newVal;
        if(prevVal === 0 && newVal === 1){  deltaUp = +1; }
        if(prevVal === 0 && newVal === -1){ deltaDown = +1; }
        if(prevVal === 1 && newVal === -1){ deltaUp = -1; deltaDown = +1; }
        if(prevVal === -1 && newVal === 1){ deltaUp = +1; deltaDown = -1; }

        const payload = vSnap.exists()
          ? { value:newVal, createdAt:vSnap.data().createdAt, updatedAt:serverTimestamp() }
          : { value:newVal, createdAt:serverTimestamp(),        updatedAt:serverTimestamp() };
        tx.set(vRef, payload);
      }

      if(deltaUp !== 0 || deltaDown !== 0){
        tx.update(pRef, {
          votesUp: increment(deltaUp),
          votesDown: increment(deltaDown),
          updatedAt: serverTimestamp()
        });
      }

      const group = document.querySelector(`.voteGroup[data-id="${postId}"]`);
      const countEl = document.getElementById(`vcount-${postId}`);
      if(group && countEl){
        const cur = parseInt(countEl.textContent,10) || 0;
        const delta = (deltaUp - deltaDown);
        countEl.textContent = String(cur + delta);
        setActive(group, nextVal);
      }
    });
  }

  function wireVotes(){
    $$('.voteGroup').forEach(group=>{
      const postId = group.getAttribute('data-id');
      group.addEventListener('click', async (e)=>{
        const btn = e.target.closest('.voteBtn'); if(!btn) return;
        const val = parseInt(btn.getAttribute('data-v'),10);
        try{ await handleVote(postId, val); }
        catch(err){
          console.error('Vote failed', err);
          alert('Sorry, your vote could not be saved. Check permissions and try again.');
        }
      });
    });
  }

  /* Sorting + queries */
  let unsubscribe=null;
  function startFeedListener(){
    if(unsubscribe) unsubscribe();
    const choice = $('#sort').value;

    if(choice==='new'){
      const qNew = query(
        collection(db,'network_posts'),
        where('status','==','published'),
        orderBy('createdAt','desc'),
        limit(50)
      );
      unsubscribe = onSnapshot(qNew, snap=>renderFeed(snap.docs), err=>console.error('Feed error (newest):',err));
    }else{
      const since = new Date(Date.now()-24*60*60*1000);
      const qTop = query(
        collection(db,'network_posts'),
        where('createdAt','>=', since),
        orderBy('createdAt','desc'),
        limit(100)
      );
      unsubscribe = onSnapshot(qTop, snap=>{
        const filtered = snap.docs.filter(d => d.data().status==='published');
        const docs = filtered.sort((a,b)=>{
          const da=a.data(), dbb=b.data();
          const sa=(da.votesUp||0)-(da.votesDown||0);
          const sb=(dbb.votesUp||0)-(dbb.votesDown||0);
          return sb-sa || (dbb.createdAt?.toMillis?.()||0)-(da.createdAt?.toMillis?.()||0);
        });
        renderFeed(docs);
      }, err=>console.error('Feed error (top24):',err));
    }
  }
  $('#sort').addEventListener('change', startFeedListener);
  startFeedListener();
</script>
</body>
</html>
